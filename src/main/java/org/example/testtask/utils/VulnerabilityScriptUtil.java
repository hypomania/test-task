package org.example.testtask.utils;

import org.example.testtask.entity.VulnerabilityScript;

import java.util.*;

public class VulnerabilityScriptUtil {
    private final HashMap<Integer, VulnerabilityScript> idToScriptMap = new HashMap<>();
    private final HashMap<Integer, Boolean> visitedScripts = new HashMap<>();
    private final List<Integer> resultList = new LinkedList<>();

    /**
     * Returns the List of Script Ids which can be used to execute scripts in a valid order
     *
     * @param scripts List of VulnerabilityScript objects
     * @return List of Integers in the valid order for the future execution
     */
    public List<Integer> generateExecutionPlan(final List<VulnerabilityScript> scripts) {
        scripts.forEach(item->idToScriptMap.put(item.getScriptId(), item));
        scripts.forEach(item->visitedScripts.put(item.getScriptId(), false));

        for (VulnerabilityScript script : scripts) {
            this.dfs(script);
        }

        return resultList;
    }

    /**
     * Recursive step of dfs algorithm. It should add scriptId that is not yet visited to the result plan
     *
     * @param script Current VulnerabilityScript
     */
    private void dfs(final VulnerabilityScript script) {
        int scriptId = script.getScriptId();
        if (visitedScripts.get(scriptId)) {
            return;
        }
        visitedScripts.put(scriptId, true);
        script.getDependencies().forEach(item->dfs(idToScriptMap.get(item)));
        resultList.add(scriptId);
    }

    public static void main(String... args) {

        VulnerabilityScript x = new VulnerabilityScript(1, Arrays.asList(2,3));
        VulnerabilityScript x2 = new VulnerabilityScript(2, Collections.singletonList(5));
        VulnerabilityScript x3 = new VulnerabilityScript(3, Arrays.asList(4,5));
        VulnerabilityScript x4 = new VulnerabilityScript(4, Collections.singletonList(5));
        VulnerabilityScript x5 = new VulnerabilityScript(5, Collections.emptyList());

        List<VulnerabilityScript> xx = Arrays.asList(x, x2, x3, x4, x5);


        VulnerabilityScriptUtil util = new VulnerabilityScriptUtil();
        List<Integer> result = util.generateExecutionPlan(xx);
        for (Integer i :
                result) {
            System.out.println(i + " ");
        }
    }
}
